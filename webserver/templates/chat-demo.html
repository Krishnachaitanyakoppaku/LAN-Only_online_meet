<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat Demo - Broadcast & Unicast</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .chat-container {
        max-width: 800px;
        margin: 0 auto;
      }
      .messages {
        height: 400px;
        border: 1px solid #ccc;
        padding: 10px;
        overflow-y: auto;
        margin-bottom: 10px;
      }
      .message {
        margin-bottom: 10px;
        padding: 8px;
        border-radius: 5px;
      }
      .broadcast {
        background-color: #f0f8ff;
      }
      .private {
        background-color: #fff0f5;
        border-left: 3px solid #ff69b4;
      }
      .server {
        background-color: #f0fff0;
        border-left: 3px solid #32cd32;
      }
      .input-group {
        margin-bottom: 10px;
      }
      .input-group input,
      .input-group select {
        margin-right: 10px;
        padding: 5px;
      }
      .btn {
        padding: 8px 15px;
        margin-right: 5px;
        cursor: pointer;
      }
      .btn-primary {
        background-color: #007bff;
        color: white;
        border: none;
      }
      .btn-success {
        background-color: #28a745;
        color: white;
        border: none;
      }
      .btn-warning {
        background-color: #ffc107;
        color: black;
        border: none;
      }
      .online-users {
        margin-bottom: 10px;
      }
      .user-list {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .user-badge {
        padding: 3px 8px;
        background-color: #e9ecef;
        border-radius: 15px;
        font-size: 12px;
      }
      .status {
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 5px;
      }
      .status.connected {
        background-color: #d4edda;
        color: #155724;
      }
      .status.error {
        background-color: #f8d7da;
        color: #721c24;
      }
    </style>
  </head>
  <body>
    <div class="chat-container">
      <h1>Chat Demo - Broadcast & Unicast</h1>

      <div class="status" id="status">Connecting...</div>

      <!-- Connection Setup -->
      <div class="input-group">
        <input type="text" id="username" placeholder="Your username" required />
        <input type="text" id="sessionId" placeholder="Session ID (optional)" />
        <button class="btn btn-primary" onclick="connectToSession()">
          Connect
        </button>
      </div>

      <!-- Online Users -->
      <div class="online-users">
        <strong>Online Users:</strong>
        <div class="user-list" id="userList"></div>
      </div>

      <!-- Messages Display -->
      <div class="messages" id="messages"></div>

      <!-- Message Input -->
      <div class="input-group">
        <select id="messageType">
          <option value="broadcast">Broadcast to All</option>
          <option value="unicast">Private Message</option>
          <option value="server">Server Message (Host Only)</option>
        </select>
        <select id="targetUser" style="display: none">
          <option value="">Select user...</option>
        </select>
        <input
          type="text"
          id="messageInput"
          placeholder="Type your message..."
          style="flex: 1; width: 300px"
        />
        <button class="btn btn-success" onclick="sendMessage()">Send</button>
      </div>

      <!-- Additional Controls -->
      <div class="input-group">
        <button class="btn btn-warning" onclick="getMessageHistory()">
          Load History
        </button>
        <button class="btn btn-warning" onclick="getOnlineUsers()">
          Refresh Users
        </button>
        <button class="btn btn-warning" onclick="sendBulkMessage()">
          Bulk Message (Host)
        </button>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script>
      let socket;
      let currentUsername = "";
      let currentSessionId = "";
      let isHost = false;
      let onlineUsers = [];

      // Message type change handler
      document
        .getElementById("messageType")
        .addEventListener("change", function () {
          const messageType = this.value;
          const targetUserSelect = document.getElementById("targetUser");

          if (messageType === "unicast") {
            targetUserSelect.style.display = "inline";
            updateTargetUserOptions();
          } else {
            targetUserSelect.style.display = "none";
          }
        });

      function connectToSession() {
        const username = document.getElementById("username").value.trim();
        const sessionId = document.getElementById("sessionId").value.trim();

        if (!username) {
          alert("Please enter a username");
          return;
        }

        currentUsername = username;
        currentSessionId = sessionId || "main_session";

        socket = io();

        socket.on("connect", function () {
          updateStatus("Connected to server", "connected");

          // Join or create session
          if (sessionId) {
            socket.emit("join_session", {
              username: username,
              session_id: sessionId,
            });
          } else {
            socket.emit("create_session", {
              username: username,
              session_id: "main_session",
            });
          }
        });

        socket.on("join_success", function (data) {
          updateStatus(`Joined session: ${data.session}`, "connected");
          currentSessionId = data.session;
          isHost = data.is_host;
          updateUserList(data.users);
          getOnlineUsers();
        });

        socket.on("create_success", function (data) {
          updateStatus(`Created session: ${data.session}`, "connected");
          currentSessionId = data.session;
          isHost = true;
          updateUserList(data.users);
          getOnlineUsers();
        });

        socket.on("new_message", function (data) {
          displayMessage(data);
        });

        socket.on("online_users_list", function (data) {
          onlineUsers = data.users;
          updateUserList(onlineUsers.map((u) => u.username));
          updateTargetUserOptions();
        });

        socket.on("message_sent", function (data) {
          addSystemMessage(`Private message sent to ${data.target_user}`);
        });

        socket.on("message_error", function (data) {
          updateStatus(`Error: ${data.error}`, "error");
        });

        socket.on("bulk_message_sent", function (data) {
          addSystemMessage(
            `Bulk message sent to ${data.sent_count}/${data.total_targets} users`
          );
        });

        socket.on("message_history", function (data) {
          document.getElementById("messages").innerHTML = "";
          data.messages.forEach((msg) => displayMessage(msg));
        });
      }

      function sendMessage() {
        const messageInput = document.getElementById("messageInput");
        const message = messageInput.value.trim();
        const messageType = document.getElementById("messageType").value;
        const targetUser = document.getElementById("targetUser").value;

        if (!message || !socket) return;

        const messageData = {
          username: currentUsername,
          message: message,
          session_id: currentSessionId,
          type: messageType,
        };

        if (messageType === "unicast" && targetUser) {
          messageData.target_user = targetUser;
        }

        if (messageType === "server") {
          socket.emit("send_server_message", {
            admin_user: currentUsername,
            message: message,
            session_id: currentSessionId,
          });
        } else {
          socket.emit("send_message", messageData);
        }

        messageInput.value = "";
      }

      function sendBulkMessage() {
        if (!isHost) {
          alert("Only host can send bulk messages");
          return;
        }

        const message = prompt("Enter bulk message:");
        if (!message) return;

        const selectedUsers = onlineUsers
          .filter((u) => u.username !== currentUsername)
          .map((u) => u.username);

        if (selectedUsers.length === 0) {
          alert("No users to send to");
          return;
        }

        socket.emit("send_bulk_message", {
          sender: currentUsername,
          session_id: currentSessionId,
          target_users: selectedUsers,
          message: message,
        });
      }

      function getMessageHistory() {
        if (socket) {
          socket.emit("get_message_history", {
            username: currentUsername,
            session_id: currentSessionId,
            limit: 50,
          });
        }
      }

      function getOnlineUsers() {
        if (socket) {
          socket.emit("get_online_users", {
            username: currentUsername,
            session_id: currentSessionId,
          });
        }
      }

      function displayMessage(data) {
        const messagesDiv = document.getElementById("messages");
        const messageDiv = document.createElement("div");
        messageDiv.className = "message";

        let messageClass = "broadcast";
        let prefix = "";

        if (data.is_private) {
          messageClass = "private";
          prefix = "[PRIVATE] ";
        } else if (data.is_server_message || data.username === "SERVER") {
          messageClass = "server";
          prefix = "[SERVER] ";
        } else if (data.is_bulk_message) {
          messageClass = "private";
          prefix = "[BULK] ";
        }

        messageDiv.className += " " + messageClass;

        const timestamp = new Date(data.timestamp).toLocaleTimeString();
        messageDiv.innerHTML = `
                <strong>${prefix}${data.username}</strong> 
                <span style="color: #666; font-size: 12px;">${timestamp}</span><br>
                ${data.message}
            `;

        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      function addSystemMessage(message) {
        displayMessage({
          username: "SYSTEM",
          message: message,
          timestamp: new Date().toISOString(),
          is_server_message: true,
        });
      }

      function updateStatus(message, type) {
        const statusDiv = document.getElementById("status");
        statusDiv.textContent = message;
        statusDiv.className = "status " + type;
      }

      function updateUserList(users) {
        const userListDiv = document.getElementById("userList");
        userListDiv.innerHTML = "";

        users.forEach((user) => {
          const userBadge = document.createElement("div");
          userBadge.className = "user-badge";
          userBadge.textContent =
            user + (user === currentUsername ? " (you)" : "");
          userListDiv.appendChild(userBadge);
        });
      }

      function updateTargetUserOptions() {
        const targetUserSelect = document.getElementById("targetUser");
        targetUserSelect.innerHTML = '<option value="">Select user...</option>';

        onlineUsers.forEach((user) => {
          if (user.username !== currentUsername) {
            const option = document.createElement("option");
            option.value = user.username;
            option.textContent =
              user.username + (user.is_host ? " (Host)" : "");
            targetUserSelect.appendChild(option);
          }
        });
      }

      // Enter key to send message
      document
        .getElementById("messageInput")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            sendMessage();
          }
        });
    </script>
  </body>
</html>
